<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Simulation Trafic - Casablanca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100vw; }
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .control-panel button {
      display: block;
      width: 230px;
      margin: 5px 0;
      padding: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .top-left-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      z-index: 1000;
      width: 250px;
    }
    .top-left-panel select,
    .top-left-panel button {
      width: 100%;
      margin-top: 5px;
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="control-panel">
  <button onclick="startMassSimulation()">üö¶ Lancer simulation trafic</button>
  <button onclick="simulateZoneTraffic()">üåê Simuler niveau de trafic par quartier</button>
</div>
<div class="top-left-panel">
  <h4>üîç Itin√©raire optimal</h4>
  <select id="startZone">
    <option value="">D√©part</option>
  </select>
  <select id="endZone">
    <option value="">Arriv√©e</option>
  </select>
  <button onclick="predictItinerary()">Pr√©voir itin√©raire</button>
  <div id="predictionResult" style="margin-top: 8px;"></div>
</div>

<script>
  const quartiers = {
    "Stade Mohammed V": [33.5888, -7.6306],
    "Gare Casa-Voyageurs": [33.6034, -7.6142],
    "Gare Casa-Port": [33.6056, -7.6131],
    "Maarif": [33.5883, -7.6246],
    "Ain Sebaa": [33.6167, -7.5167],
    "Hay Hassani": [33.5667, -7.6667],
    "Derb Ghallef": [33.5800, -7.6250],
    "Oasis": [33.5668, -7.6306],
    "Sidi Maarouf": [33.5390, -7.6293],
    "Quartier des H√¥pitaux": [33.5770, -7.6186],
    "Bourgogne": [33.5951, -7.6460],
    "Anfa": [33.5892, -7.6593],
    "Palmier": [33.5791, -7.6248],
    "Mers Sultan": [33.5808, -7.6003],
    "Roches Noires": [33.6040, -7.5810],
    "Hay Mohammadi": [33.6045, -7.5584],
    "La Gironde": [33.5833, -7.6056],
    "Les H√¥pitaux": [33.5725, -7.6180],
    "Bd Zerktouni": [33.5885, -7.6185],
    "Gauthier": [33.5895, -7.6328],
    "Corniche A√Øn Diab": [33.5800, -7.6840],
    "Morocco Mall": [33.5595, -7.6911],
    "Technopark": [33.5552, -7.6523],
    "Casa Nearshore": [33.5235, -7.6420],
    "Hay Lalla Meriem": [33.5511, -7.6233],
    "Hay Nahda": [33.5633, -7.5733],
    "Hay El Fida": [33.5867, -7.5870],
    "Derb Sultan": [33.5720, -7.5933],
    "A√Øn Chock": [33.5450, -7.6020],
    "Sbata": [33.5620, -7.5670],
    "Hay Errahma": [33.5010, -7.6550],
    "Tachfine Center": [33.5835, -7.5837],
    "Bab Marrakech (ancienne m√©dina)": [33.6012, -7.6125],
    "Bd Moulay Slimane": [33.6073, -7.5995],
    "Twin Center": [33.5829, -7.6336],
    "Universit√© Hassan II": [33.5482, -7.6551],
  };

  const types = ["car", "bus", "tram", "taxi"];

  const icons = {
    car: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/744/744465.png', iconSize: [28, 28] }),
    bus: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/422/422911.png', iconSize: [28, 28] }),
    taxi: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/741/741446.png', iconSize: [28, 28] }),
    tram: L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/2390/2390300.png',
      iconSize: [28, 28]
    }),
  };

  const map = L.map('map').setView([33.5731, -7.5898], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  for (const name in quartiers) {
    const [lat, lon] = quartiers[name];
    L.marker([lat, lon]).addTo(map).bindPopup(name);
  }

  function getRandomZone(exclude = null) {
    const keys = Object.keys(quartiers).filter(k => k !== exclude);
    const random = keys[Math.floor(Math.random() * keys.length)];
    return { name: random, coords: quartiers[random] };
  }

  function animateAgent(type, from, to, duration = 5000) {
    const marker = L.marker(from.coords, { icon: icons[type] }).addTo(map);
    marker.bindPopup(`${type.toUpperCase()}<br>${from.name} ‚Üí ${to.name}`);
    const steps = 180;
    let step = 0;

    const latStep = (to.coords[0] - from.coords[0]) / steps;
    const lngStep = (to.coords[1] - from.coords[1]) / steps;

    const interval = setInterval(() => {
      step++;
      const newLat = from.coords[0] + latStep * step;
      const newLng = from.coords[1] + lngStep * step;
      marker.setLatLng([newLat, newLng]);
      if (step >= steps) {
        clearInterval(interval);
        map.removeLayer(marker);
      }
    }, duration / steps);
  }

  function startMassSimulation() {
    setInterval(() => {
      for (let i = 0; i < 55; i++) {
        const type = types[Math.floor(Math.random() * types.length)];
        const from = getRandomZone();
        const to = getRandomZone(from.name);
        const duration = type === 'bus' ? 10000 : type === 'tram' ? 8000 : type === 'car' ? 7000 : 6000;
        animateAgent(type, from, to, duration);
      }
    }, 500);
  }

  // TRAFIC ZONAL : cercles color√©s
  let trafficCircles = [];

  function simulateZoneTraffic() {
    // supprimer anciens cercles
    trafficCircles.forEach(c => map.removeLayer(c));
    trafficCircles = [];

    for (const zone in quartiers) {
      const [lat, lon] = quartiers[zone];
      const level = ["Low", "Moderate", "High"][Math.floor(Math.random() * 3)];
      let color = level === "High" ? "red" : level === "Moderate" ? "orange" : "green";

      const circle = L.circle([lat, lon], {
        color,
        fillColor: color,
        fillOpacity: 0.3,
        radius: 600
      }).addTo(map).bindPopup(`${zone}<br>Trafic : ${level}`);
      trafficCircles.push(circle);
    }
  }

  // Remplir les dropdowns au d√©marrage
  window.onload = () => {
    const startSelect = document.getElementById("startZone");
    const endSelect = document.getElementById("endZone");
    Object.keys(quartiers).forEach(name => {
      const opt1 = document.createElement("option");
      opt1.value = name;
      opt1.text = name;
      const opt2 = opt1.cloneNode(true);
      startSelect.appendChild(opt1);
      endSelect.appendChild(opt2);
    });
  };

  function predictItinerary() {
    const start = document.getElementById("startZone").value;
    const end = document.getElementById("endZone").value;
    const resultBox = document.getElementById("predictionResult");

    if (!start || !end || start === end) {
      resultBox.innerHTML = `<span style="color:red;">S√©lection invalide.</span>`;
      return;
    }

    // Simulation simple
    const transports = ["Bus", "Taxi", "Tram"];
    const chosen = transports[Math.floor(Math.random() * transports.length)];
    const time = (Math.random() * (20 - 7) + 7).toFixed(1); // 7‚Äì20 minutes

    resultBox.innerHTML = `
      <b>D√©part:</b> ${start}<br>
      <b>Arriv√©e:</b> ${end}<br>
      <b>Transport:</b> ${chosen}<br>
      <b>Temps estim√©:</b> ${time} min
    `;
  }
</script>

</body>
</html>
